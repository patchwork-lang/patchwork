# Checkpoint: Phase 4 Complete - Agent Infrastructure

## Session Overview

Completed Phase 4 of the Patchwork ACP interpreter implementation. Built the full agent infrastructure for LLM communication in `crates/patchwork-acp/src/agent.rs`.

## What Was Built

### Core Types
```rust
pub struct Agent {
    tx: UnboundedSender<AgentRequest>,
}

pub enum AgentRequest {
    Think {
        prompt: String,
        bindings: HashMap<String, Value>,
        expect: String,
        response_tx: oneshot::Sender<ThinkResult>,
    },
}
```

### Key Components

1. **Agent::new(cx, mcp_registry)** - Creates agent using proxy's connection context
   - Spawns redirect actor for message routing
   - Spawns request loop to process AgentRequests
   - Returns Agent handle and redirect_tx for notifications

2. **redirect_actor()** - Maintains stack of active thinkers
   - Handles PushThinker/PopThinker for nested think blocks
   - Routes incoming SACP messages to top of stack

3. **think_message()** - Handles individual think blocks
   - Creates new session with successor (claude-code-acp)
   - Sends augmented prompt with type hints
   - Accumulates streaming response
   - Extracts typed value from markdown code fences

4. **create_mcp_server()** - Factory for "do" tool
   - Enables recursive evaluation when LLM calls do(index)
   - Prepared for Phase 5 integration

5. **Response Extraction**
   - `extract_code_fence()` - Parses ```text and ```json blocks
   - `extract_response_value()` - Type-aware extraction with fallback
   - `augment_prompt_with_type_hint()` - Appends formatting instructions

### Architecture Decision

The Agent lives in `patchwork-acp` (not `patchwork-eval`) because it's deeply integrated with SACP. The interpreter will just need a lightweight sender to communicate with it.

## Test Results

287 tests pass across workspace (8 new tests for code fence extraction):
- test_extract_code_fence_text
- test_extract_code_fence_json
- test_extract_code_fence_no_fence
- test_extract_response_value_string
- test_extract_response_value_json
- test_extract_response_value_fallback
- test_augment_prompt_string
- test_augment_prompt_json

## Files Changed

- `crates/patchwork-acp/src/agent.rs` - NEW: Full agent infrastructure
- `crates/patchwork-acp/src/main.rs` - Added `mod agent`
- `crates/patchwork-acp/Cargo.toml` - Added schemars 1.1
- `docs/patchwork-acp-implementation-plan.md` - Marked Phase 4 complete

## Next: Phase 5

Connect interpreter to agent:
1. Update `Interpreter` to accept agent handle
2. Update `eval_think_block()` to block on agent channel
3. Update proxy to spawn interpreter threads with agent
4. Wire up session notification handler in proxy